/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/6.8/samples
 */

plugins {
	id 'java'
	id 'idea'
}

repositories {
	mavenCentral()
}

dependencies {
	implementation fileTree(dir: 'libs', include: ['bcprov-*.jar'])
	implementation 'at.favre.lib:bytes:1.5.0'

	testImplementation 'junit:junit:4.12'
	testImplementation 'org.powermock:powermock-api-mockito:1.6.6'
	testImplementation 'org.powermock:powermock-module-junit4:1.6.6'
}

task generateSources(type: Copy) {
	delete '$buildDir/sources'

	var bcprov = "BouncyCastle library not found"

	for (f in new File(rootDir, "libs").listFiles())
	{
		if (f.name.startsWith("bcprov") && f.getName().endsWith(".jar")) {
			bcprov = f.name
			System.out.println("Found BouncyCastle security provider: $bcprov")
		}
	}

	filteringCharset = 'utf8'
	from 'src/main/java'
	into "$buildDir/sources"
	filter { line -> line.replace('%BouncyCastleProvider%', bcprov) }
}

compileJava.options.encoding = 'UTF-8'
compileJava.setSource "$buildDir/sources"
compileJava.dependsOn generateSources

jar {
	manifest {
		attributes 'Main-Class': 'fancytext.Launch'
	}

	from('libs') {
		include 'bcprov-*.jar'
	}
	from {
		configurations.runtimeClasspath.filter { !it.name.startsWith('bcprov') }.collect {
			it.isDirectory() ? it : zipTree(it)
		}
	}

	exclude 'META-INF/*.RSA', 'META-INF/*.SF', 'META-INF/*.DSA'
}
